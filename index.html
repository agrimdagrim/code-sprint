<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crossword Sprint</title>
    <link rel="stylesheet" type="text/css" href="exolve-m.css">
    <style>
        body { font-family: sans-serif; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 20px; }
       .card { background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 900px; width: 100%; text-align: center; }
       .hidden { display: none!important; }
        button { background: #4285f4; color: white; border: none; padding: 10px 20px; font-size: 16px; border-radius: 4px; cursor: pointer; }
        button:hover { background: #357ae8; }
        #puzzle-container { margin-top: 20px; min-height: 500px; }
       .status-bar { display: flex; justify-content: space-between; width: 100%; margin-bottom: 20px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="login-screen" class="card">
        <h1>Crossword Sprint</h1>
        <p>Log in to join the waiting room.</p>
        <button id="btn-login">Sign in with Google</button>
    </div>

    <div id="waiting-screen" class="card hidden">
        <h1>Waiting for Host...</h1>
        <p>The competition hasn't started yet.</p>
        <p>Signed in as: <span id="user-name"></span></p>
    </div>

    <div id="game-screen" class="card hidden">
        <div class="status-bar">
            <span>Puzzles Solved: <span id="score">0</span></span>
            <span id="timer">Live</span>
        </div>
        <div id="puzzle-container"></div>
    </div>

    <div id="finish-screen" class="card hidden">
        <h1>Competition Finished!</h1>
        <p>Your final score: <span id="final-score">0</span></p>
    </div>

    <script src="exolve-m.js"></script>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, increment, serverTimestamp, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // --- PASTE YOUR FIREBASE CONFIG HERE ---
       const firebaseConfig = {
  apiKey: "AIzaSyAxE15bKJMkKPEGxm3aF_ih8L6bY7B0R9w",
  authDomain: "crossword-sprint.firebaseapp.com",
  projectId: "crossword-sprint",
  storageBucket: "crossword-sprint.firebasestorage.app",
  messagingSenderId: "152789480102",
  appId: "1:152789480102:web:c49c82b5beafa31093ba67",
  measurementId: "G-G5MWLKCBZW"
};

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const COMP_ID = "sprint_001"; // Must match your Firestore Document ID

        let currentUser = null;
        let puzzleSet = [];
        let currentPuzzleIndex = 0;
        let activePuzzleObj = null;

        // 1. Auth Handling
        document.getElementById('btn-login').addEventListener('click', () => {
            signInWithPopup(auth, new GoogleAuthProvider());
        });

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('user-name').textContent = user.displayName;
                document.getElementById('login-screen').classList.add('hidden');
                
                // Initialize User Stats in DB
                const playerRef = doc(db, 'competitions', COMP_ID, 'players', user.uid);
                const playerSnap = await getDoc(playerRef);
                if (!playerSnap.exists()) {
                    await setDoc(playerRef, {
                        name: user.displayName,
                        solvedCount: 0,
                        currentPuzzleIndex: 0,
                        lastSolved: serverTimestamp()
                    });
                } else {
                    currentPuzzleIndex = playerSnap.data().currentPuzzleIndex || 0;
                    document.getElementById('score').textContent = playerSnap.data().solvedCount || 0;
                }

                listenToGameState();
            }
        });

        // 2. Game State Listener
        function listenToGameState() {
            onSnapshot(doc(db, 'competitions', COMP_ID), (doc) => {
                const data = doc.data();
                const status = data.status;
                puzzleSet = data.puzzleSet || [];

                if (status === 'waiting') {
                    showScreen('waiting-screen');
                } else if (status === 'active') {
                    showScreen('game-screen');
                    loadCurrentPuzzle();
                } else if (status === 'stopped') {
                    document.getElementById('final-score').textContent = document.getElementById('score').textContent;
                    showScreen('finish-screen');
                    if (activePuzzleObj) activePuzzleObj.destroy();
                }
            });
        }

        function showScreen(id) {
            ['login-screen', 'waiting-screen', 'game-screen', 'finish-screen'].forEach(s => {
                document.getElementById(s).classList.add('hidden');
            });
            document.getElementById(id).classList.remove('hidden');
        }

        // 3. Exolve Dynamic Loading
        function loadCurrentPuzzle() {
            // Check if we already have the correct puzzle loaded to avoid re-rendering
            if (activePuzzleObj && activePuzzleObj.puzzleIndex === currentPuzzleIndex) return;
            
            // Clean up previous instance
            const container = document.getElementById('puzzle-container');
            if (activePuzzleObj) {
                activePuzzleObj.destroy();
                activePuzzleObj = null;
            }
            container.innerHTML = ''; // Force clear DOM

            if (currentPuzzleIndex >= puzzleSet.length) {
                container.innerHTML = "<h3>All puzzles solved! Wait for timer.</h3>";
                return;
            }

            // Load New Puzzle
            // createExolve(puzzleText, containerId, customizer, provideStateUrl, visTop, maxDim, notTemp)
            // setting notTemp to false is CRITICAL to prevent caching state
            try {
                activePuzzleObj = createExolve(puzzleSet[currentPuzzleIndex], 'puzzle-container', null, false, 0, 0, false);
                activePuzzleObj.puzzleIndex = currentPuzzleIndex;
            } catch(e) {
                console.error("Error loading puzzle:", e);
            }
        }

        // 4. Solve Detection
        // Exolve fires a custom event named 'exolve' on the window/container
        window.addEventListener('exolve', async (e) => {
            // Check if the puzzle is fully filled and correct
            if (e.detail && e.detail.knownCorrect) {
                // Prevent double submissions
                if (activePuzzleObj && !activePuzzleObj.hasSubmitted) {
                    activePuzzleObj.hasSubmitted = true;
                    
                    // Update UI
                    alert("Correct! Next Puzzle...");
                    currentPuzzleIndex++;
                    document.getElementById('score').textContent = currentPuzzleIndex;
                    
                    // Update DB
                    const playerRef = doc(db, 'competitions', COMP_ID, 'players', currentUser.uid);
                    await updateDoc(playerRef, {
                        solvedCount: increment(1),
                        currentPuzzleIndex: increment(1),
                        lastSolved: serverTimestamp()
                    });

                    // Load next
                    loadCurrentPuzzle();
                }
            }
        });
    </script>
</body>
</html>