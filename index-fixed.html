<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crossword Sprint</title>
    <link rel="stylesheet" type="text/css" href="exolve-m.css">
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            background: #f0f2f5; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            margin: 0; 
            padding: 20px; 
        }
        .card { 
            background: white; 
            padding: 2rem; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            max-width: 900px; 
            width: 100%; 
            text-align: center; 
        }
        .hidden { display: none !important; }
        button { 
            background: #4285f4; 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            font-size: 16px; 
            border-radius: 4px; 
            cursor: pointer; 
            font-weight: 500;
        }
        button:hover { background: #357ae8; }
        button:active { transform: scale(0.98); }
        button:disabled { background: #ccc; cursor: not-allowed; }
        #puzzle-container { margin-top: 20px; min-height: 400px; }
        .status-bar { 
            display: flex; 
            justify-content: space-between; 
            width: 100%; 
            margin-bottom: 20px; 
            font-weight: bold;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 4px;
        }
        .status-bar span { font-size: 18px; }
        .error { color: #d32f2f; padding: 15px; background: #ffebee; border-radius: 4px; margin: 10px 0; }
        .success { color: #388e3c; padding: 15px; background: #e8f5e9; border-radius: 4px; margin: 10px 0; }
        .loading { text-align: center; padding: 20px; }
        .spinner { 
            border: 4px solid #f3f3f3; 
            border-top: 4px solid #4285f4; 
            border-radius: 50%; 
            width: 40px; 
            height: 40px; 
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        h1 { color: #333; margin-top: 0; }
        p { color: #666; }
    </style>
</head>
<body>

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="card">
        <h1>üéØ Crossword Sprint</h1>
        <p>A 1-hour speed competition to solve as many crosswords as possible.</p>
        <button id="btn-login">Sign in with Google</button>
        <div id="login-error" class="error hidden"></div>
    </div>

    <!-- WAITING SCREEN -->
    <div id="waiting-screen" class="card hidden">
        <h1>‚è≥ Waiting for Admin...</h1>
        <p>The competition hasn't started yet.</p>
        <p style="font-weight: bold; color: #4285f4;">Signed in as: <span id="user-name"></span></p>
        <div class="loading">
            <div class="spinner"></div>
            <p>Waiting for admin to start the game...</p>
        </div>
    </div>

    <!-- GAME SCREEN -->
    <div id="game-screen" class="card hidden">
        <div class="status-bar">
            <span>‚úÖ Solved: <span id="score">0</span></span>
            <span id="timer">--:--</span>
        </div>
        <div id="puzzle-status" class="loading hidden">
            <div class="spinner"></div>
            <p>Loading puzzle...</p>
        </div>
        <div id="puzzle-container"></div>
    </div>

    <!-- FINISH SCREEN -->
    <div id="finish-screen" class="card hidden">
        <h1>üèÅ Competition Finished!</h1>
        <p style="font-size: 24px; color: #4285f4; font-weight: bold;">Your final score: <span id="final-score">0</span></p>
        <p>Thanks for competing!</p>
    </div>

    <script src="exolve-m.js"></script>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, increment, serverTimestamp, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // ============================================
        // FIREBASE CONFIG - REPLACE WITH YOUR VALUES
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyAxE15bKJMkKPEGxm3aF_ih8L6bY7B0R9w",
            authDomain: "crossword-sprint.firebaseapp.com",
            projectId: "crossword-sprint",
            storageBucket: "crossword-sprint.firebasestorage.app",
            messagingSenderId: "152789480102",
            appId: "1:152789480102:web:c49c82b5beafa31093ba67",
            measurementId: "G-G5MWLKCBZW"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const COMP_ID = "sprint_001";

        // ============================================
        // STATE MANAGEMENT
        // ============================================
        let currentUser = null;
        let puzzleSet = [];
        let currentPuzzleIndex = 0;
        let activePuzzleObj = null;
        let gameStartTime = null;
        let timerInterval = null;
        let gameActive = false;
        let puzzleSubmitted = false;

        // ============================================
        // 1. AUTHENTICATION
        // ============================================
        document.getElementById('btn-login').addEventListener('click', () => {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider).catch(error => {
                showError('Login Error: ' + error.message);
            });
        });

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('user-name').textContent = user.displayName || user.email;
                document.getElementById('login-screen').classList.add('hidden');
                
                try {
                    // Initialize or update player document
                    const playerRef = doc(db, 'competitions', COMP_ID, 'players', user.uid);
                    const playerSnap = await getDoc(playerRef);
                    
                    if (!playerSnap.exists()) {
                        await setDoc(playerRef, {
                            name: user.displayName || user.email,
                            email: user.email,
                            solvedCount: 0,
                            lastSolved: serverTimestamp(),
                            createdAt: serverTimestamp()
                        });
                    } else {
                        // Load existing score
                        const data = playerSnap.data();
                        document.getElementById('score').textContent = data.solvedCount || 0;
                    }

                    // Start listening to game state
                    listenToGameState();
                } catch (error) {
                    console.error('Error initializing player:', error);
                    showError('Database Error: ' + error.message);
                }
            }
        });

        // ============================================
        // 2. GAME STATE LISTENER
        // ============================================
        function listenToGameState() {
            onSnapshot(doc(db, 'competitions', COMP_ID), (docSnap) => {
                if (!docSnap.exists()) {
                    showError('Competition not found. Ask admin to set up the game.');
                    return;
                }

                const data = docSnap.data();
                const status = data.status || 'waiting';
                puzzleSet = data.puzzleSet || [];

                console.log('Game status:', status);
                console.log('Puzzles available:', puzzleSet.length);

                if (status === 'waiting') {
                    showScreen('waiting-screen');
                    gameActive = false;
                    if (timerInterval) clearInterval(timerInterval);
                } else if (status === 'active') {
                    showScreen('game-screen');
                    gameActive = true;
                    if (!gameStartTime) {
                        gameStartTime = Date.now();
                        startTimer();
                    }
                    loadCurrentPuzzle();
                } else if (status === 'stopped') {
                    gameActive = false;
                    if (timerInterval) clearInterval(timerInterval);
                    document.getElementById('final-score').textContent = document.getElementById('score').textContent;
                    showScreen('finish-screen');
                    if (activePuzzleObj) {
                        try {
                            activePuzzleObj.destroy();
                        } catch (e) {
                            console.warn('Error destroying puzzle:', e);
                        }
                    }
                }
            });
        }

        // ============================================
        // 3. TIMER LOGIC
        // ============================================
        function startTimer() {
            timerInterval = setInterval(() => {
                if (gameStartTime && gameActive) {
                    const elapsed = Math.floor((Date.now() - gameStartTime) / 1000);
                    const minutes = Math.floor(elapsed / 60);
                    const seconds = elapsed % 60;
                    document.getElementById('timer').textContent = 
                        `${minutes}:${seconds.toString().padStart(2, '0')}`;
                }
            }, 100);
        }

        // ============================================
        // 4. SCREEN MANAGEMENT
        // ============================================
        function showScreen(id) {
            const screens = ['login-screen', 'waiting-screen', 'game-screen', 'finish-screen'];
            screens.forEach(screenId => {
                document.getElementById(screenId).classList.add('hidden');
            });
            document.getElementById(id).classList.remove('hidden');
        }

        function showError(message) {
            const errorDiv = document.getElementById('login-error');
            errorDiv.textContent = '‚ùå ' + message;
            errorDiv.classList.remove('hidden');
        }

        // ============================================
        // 5. PUZZLE LOADING
        // ============================================
        function loadCurrentPuzzle() {
            // Validate puzzle data exists
            if (!puzzleSet || puzzleSet.length === 0) {
                showPuzzleError('No puzzles uploaded yet. Admin must upload puzzles.');
                return;
            }

            if (currentPuzzleIndex >= puzzleSet.length) {
                showPuzzleStatus('All puzzles solved! Wait for competition to end.');
                return;
            }

            const puzzleText = puzzleSet[currentPuzzleIndex];
            if (!puzzleText) {
                showPuzzleError('Puzzle data missing or corrupted.');
                return;
            }

            // Reset submission flag for new puzzle
            puzzleSubmitted = false;

            // Clean up previous puzzle
            const container = document.getElementById('puzzle-container');
            if (activePuzzleObj) {
                try {
                    activePuzzleObj.destroy();
                } catch (e) {
                    console.warn('Error destroying previous puzzle:', e);
                }
                activePuzzleObj = null;
            }
            container.innerHTML = '';

            // Show loading indicator
            showPuzzleStatus('Loading puzzle...');

            try {
                // Create new puzzle instance with critical settings:
                // - notTemp=false: prevents state caching in local storage
                // - provideStateUrl=false: no URL state management
                activePuzzleObj = createExolve(
                    puzzleText,
                    'puzzle-container',
                    null,
                    false,  // provideStateUrl
                    0,      // visTop
                    0,      // maxDim
                    false   // notTemp (critical for dynamic loading)
                );

                // Store puzzle index for reference
                activePuzzleObj.userPuzzleIndex = currentPuzzleIndex;

                // Hide loading indicator
                hidePuzzleStatus();

                // Start checking for completion
                startPuzzleCompletionCheck();

                console.log('Loaded puzzle', currentPuzzleIndex + 1, 'of', puzzleSet.length);

            } catch (error) {
                console.error('Error loading puzzle:', error);
                showPuzzleError('Failed to load puzzle: ' + error.message);
            }
        }

        // ============================================
        // 6. PUZZLE COMPLETION DETECTION
        // ============================================
        let completionCheckInterval = null;

        function startPuzzleCompletionCheck() {
            // Clear any existing interval
            if (completionCheckInterval) {
                clearInterval(completionCheckInterval);
            }

            // Check every 500ms if puzzle is complete
            completionCheckInterval = setInterval(() => {
                checkAndSubmitPuzzle();
            }, 500);
        }

        function checkAndSubmitPuzzle() {
            if (!activePuzzleObj || puzzleSubmitted || !gameActive) {
                return;
            }

            // Check if puzzle is completely filled and correct
            // These are internal Exolve properties that track state
            const allCellsFilled = activePuzzleObj.cellsAnswered && 
                                   activePuzzleObj.cellsAnswered.length > 0 &&
                                   activePuzzleObj.cellsAnswered.every(cell => cell.currLetter && cell.currLetter !== '?');
            
            const isCorrect = activePuzzleObj.solved === true;

            // Alternative: check using the grid directly
            let manualCheck = false;
            if (activePuzzleObj.grid && activePuzzleObj.gridWidth > 0) {
                let allFilled = true;
                let allCorrect = true;

                for (let i = 0; i < activePuzzleObj.gridHeight; i++) {
                    for (let j = 0; j < activePuzzleObj.gridWidth; j++) {
                        const cell = activePuzzleObj.grid[i][j];
                        if (!cell) continue;
                        if (!cell.isLight) continue;

                        // Check if cell is filled
                        if (!cell.currLetter || cell.currLetter === '?' || cell.currLetter === '.') {
                            allFilled = false;
                            break;
                        }

                        // Check if cell is correct
                        if (cell.currLetter !== cell.solution && cell.solution !== '?') {
                            allCorrect = false;
                            break;
                        }
                    }
                    if (!allFilled || !allCorrect) break;
                }

                manualCheck = allFilled && allCorrect;
            }

            if (isCorrect || manualCheck) {
                submitPuzzle();
            }
        }

        async function submitPuzzle() {
            if (puzzleSubmitted || !currentUser) {
                return;
            }

            puzzleSubmitted = true;
            clearInterval(completionCheckInterval);

            try {
                // Get fresh player data to prevent race conditions
                const playerRef = doc(db, 'competitions', COMP_ID, 'players', currentUser.uid);
                const playerSnap = await getDoc(playerRef);
                const currentData = playerSnap.data();

                const newSolvedCount = (currentData.solvedCount || 0) + 1;
                const newPuzzleIndex = currentPuzzleIndex + 1;

                // Update player document
                await updateDoc(playerRef, {
                    solvedCount: newSolvedCount,
                    lastSolved: serverTimestamp()
                });

                // Update UI
                document.getElementById('score').textContent = newSolvedCount;

                // Show success message briefly
                showPuzzleStatus(`‚úÖ Puzzle ${currentPuzzleIndex + 1} solved! Loading next...`);

                // Move to next puzzle
                currentPuzzleIndex = newPuzzleIndex;

                // Load next puzzle after a short delay
                setTimeout(() => {
                    loadCurrentPuzzle();
                }, 1000);

            } catch (error) {
                console.error('Error submitting puzzle:', error);
                puzzleSubmitted = false;
                startPuzzleCompletionCheck();
            }
        }

        // ============================================
        // 7. UI HELPERS
        // ============================================
        function showPuzzleStatus(message) {
            const statusDiv = document.getElementById('puzzle-status');
            statusDiv.innerHTML = `<div class="loading"><div class="spinner"></div><p>${message}</p></div>`;
            statusDiv.classList.remove('hidden');
        }

        function showPuzzleError(message) {
            const statusDiv = document.getElementById('puzzle-status');
            statusDiv.innerHTML = `<div class="error">${message}</div>`;
            statusDiv.classList.remove('hidden');
        }

        function hidePuzzleStatus() {
            document.getElementById('puzzle-status').classList.add('hidden');
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        console.log('Crossword Sprint - Player Client initialized');
        console.log('Firebase Project:', firebaseConfig.projectId);
    </script>
</body>
</html>
